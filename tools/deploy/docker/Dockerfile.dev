# syntax=docker/dockerfile:1.7
# =============================================================================
# Development Python Container
# =============================================================================
# This Dockerfile creates a development container with hot-reloading enabled.
#
# Features:
# - All development dependencies included
# - Hot-reload enabled for rapid development
# - Build tools available for native extensions
#
# Build: docker build -f Dockerfile.dev -t app:dev .
# =============================================================================

# -----------------------------------------------------------------------------
# Build Arguments
# -----------------------------------------------------------------------------
ARG PYTHON_VERSION=3.12
ARG DEBIAN_VERSION=bookworm
ARG BUILDER_IMAGE=python:${PYTHON_VERSION}-slim-${DEBIAN_VERSION}

# =============================================================================
# Stage 1: Python Base
# =============================================================================
FROM ${BUILDER_IMAGE} AS python-base

ARG LITESTAR_APP="app.asgi:create_app"
ARG UV_INSTALL_ARGS="--all-extras --dev"

ENV UV_LINK_MODE=copy \
    UV_COMPILE_BYTECODE=1 \
    UV_INSTALL_ARGS="${UV_INSTALL_ARGS}" \
    PATH="/workspace/app/.venv/bin:/usr/local/bin:$PATH" \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONFAULTHANDLER=1 \
    PYTHONHASHSEED=random \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    LITESTAR_APP="${LITESTAR_APP}"

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update \
    && apt-get upgrade -y \
    && apt-get install -y --no-install-recommends \
        build-essential \
        git \
        tini \
        ca-certificates \
    && rm -rf /var/log/* /tmp/* \
    && mkdir -p /workspace/app /cloudsql

# Install uv (fast Python package installer)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

# Install bun (fast JavaScript runtime/bundler)
COPY --from=oven/bun:latest /usr/local/bin/bun /usr/local/bin/bun

# =============================================================================
# Stage 2: Builder
# =============================================================================
FROM python-base AS builder

ARG UV_INSTALL_ARGS="--all-extras --dev"

ENV GRPC_PYTHON_BUILD_WITH_CYTHON=1 \
    UV_LINK_MODE=copy \
    UV_NO_CACHE=1 \
    UV_COMPILE_BYTECODE=1 \
    UV_INSTALL_ARGS="${UV_INSTALL_ARGS}" \
    UV_SYSTEM_PYTHON=1 \
    PATH="/workspace/app/.venv/bin:/usr/local/bin:$PATH" \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONFAULTHANDLER=1 \
    PYTHONHASHSEED=random \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

WORKDIR /workspace/app

# Copy dependency files first (better layer caching)
COPY pyproject.toml uv.lock package.json bun.lock ./
COPY components.json biome.json vite.config.ts tsconfig.json ./

COPY tools ./tools/

# Install JavaScript dependencies
RUN bun install --frozen-lockfile

# Create virtual environment and install Python dependencies
RUN uv venv \
    && uv sync ${UV_INSTALL_ARGS} --frozen --no-install-project --no-editable

# Copy application source
COPY resources ./resources/
COPY app ./app/

# Build frontend assets
RUN uv run tools/assets.py --build-assets \
    && uv sync ${UV_INSTALL_ARGS} --frozen

# Container configuration
STOPSIGNAL SIGTERM
EXPOSE 8000

ENTRYPOINT ["tini", "--"]
CMD ["litestar", "run", "--host", "0.0.0.0", "--port", "8000", "--reload"]

VOLUME /workspace/app
